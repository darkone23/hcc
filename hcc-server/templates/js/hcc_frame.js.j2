(function() {

var origin = '{{ origin_domain  }}';
var token = '{{ csrf_secret_token }}';
var pubkey = '{{ server_pub_key }}';

var frame = document.getElementById("hcc-frame").contentWindow;
var senderId = 0;

function handleAck(event) {
    if(event.origin !== origin) return;
    if (event.data === "ack-token") {
        window.clearInterval(senderId);
        window.removeEventListener('message', handleAck);
    }
}

function sendToken() {
	frame.postMessage({token: token, pubkey: pubkey}, origin);
}

frame.addEventListener('load', sendToken, true);
senderId = setInterval(sendToken, 20);

window.addEventListener('message', handleAck);

function reload(event) {
    if(event.origin !== origin) return;
    if (event.data === "reload") {
        window.removeEventListener('message', reload);
        window.location.reload(true);
    }
}

window.addEventListener('message', reload);

})();